<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DotNet Core | Flash&#39;s BLOG</title>
    <meta name="description" content="對於我這種只有一點點知識又沒錢的傢伙只好自行徒手建立這BLOG">
    
    
    <link rel="preload" href="/flashlin.github.io/assets/css/0.styles.7db30d77.css" as="style"><link rel="preload" href="/flashlin.github.io/assets/js/app.b3c6e42b.js" as="script"><link rel="preload" href="/flashlin.github.io/assets/js/2.d3d2ff54.js" as="script"><link rel="preload" href="/flashlin.github.io/assets/js/22.115aba78.js" as="script"><link rel="prefetch" href="/flashlin.github.io/assets/js/10.bb3f184f.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/11.10b8376f.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/12.c8e6bb1d.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/13.f1e7e743.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/14.500f0f8e.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/15.68f57b87.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/16.c79835b3.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/17.a2ad7d63.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/18.116d71ea.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/19.0a01114a.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/20.2a30e1c0.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/21.471f3d8f.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/23.aff23f44.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/24.8a13840e.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/25.3ac5803d.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/26.6a5682ad.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/27.96355e05.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/28.a6524c20.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/29.4b3e2772.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/3.c435e1b2.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/30.f4772cb0.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/31.1eb3bfff.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/32.b2293c12.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/33.0511014a.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/34.93b48978.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/35.4eba577f.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/36.4354cbd3.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/37.293c05ee.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/38.c68e30f3.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/39.5fbaf21f.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/4.1d6105b4.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/40.dfac0c8f.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/41.a4d3f08b.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/42.850c4dc9.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/43.06a9e4c3.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/44.eb78b9f2.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/45.9d168031.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/46.c4338166.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/47.802a8dc6.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/48.3c075de4.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/5.bc3d4d9d.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/6.8663ee14.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/7.a40d3aa2.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/8.b05c70ef.js"><link rel="prefetch" href="/flashlin.github.io/assets/js/9.7dd8756c.js">
    <link rel="stylesheet" href="/flashlin.github.io/assets/css/0.styles.7db30d77.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/flashlin.github.io/" class="home-link router-link-active"><!----> <span class="site-name">Flash's BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/flashlin.github.io/" class="nav-link">Home</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/flashlin.github.io/" class="nav-link">Home</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Home</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>DotNet-Core</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/flashlin.github.io/DotNet-Core/20191010-1720-UsingDifferentServicesWithSameIService.html" class="sidebar-link">IoC 進階應用</a></li><li><a href="/flashlin.github.io/DotNet-Core/20191017-2000-HttpClient.html" class="sidebar-link">HttpClient 使用注意事項</a></li><li><a href="/flashlin.github.io/DotNet-Core/20191027-1000-Kubernetes-Liveness-Readiness.html" class="sidebar-link">Kubernetes Health Check 探針</a></li><li><a href="/flashlin.github.io/DotNet-Core/20191103-0800-GenerateEfCoreCodeFirstModels.html" class="sidebar-link">從資料庫自動產生 Entity Framework Code First 模型(Models)</a></li><li><a href="/flashlin.github.io/DotNet-Core/20191112-1200-QuartzWithDi.html" class="sidebar-link">Quartz with Dotnet core DI</a></li><li><a href="/flashlin.github.io/DotNet-Core/AspNetCore.html" class="active sidebar-link">DotNet Core</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DotNet</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Typescripts</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>設計守則</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>錯誤集錦</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dotnet-core"><a href="#dotnet-core" aria-hidden="true" class="header-anchor">#</a> DotNet Core</h1> <ul><li><p>在Asp.net Core 中引用dll，以往我們引用DLL 都是直接引用，
在Core 裡這樣是不行的，必須基於NuGet 添加，或者基於project.json 添加</p></li> <li><p>Core 裡使用Session 需要添加Session package</p></li></ul> <blockquote><p>nuget Microsoft.AspNetCore.Session</p></blockquote> <p>在Startup.cs 中增加以下程式碼</p> <div class="language- extra-class"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
	services.AddMvc();
	services.AddSession(); 
}

public void Configure(IApplicationBuilder app){
    app.UseSession();
}
</code></pre></div><p>在Controller 中</p> <div class="language- extra-class"><pre class="language-text"><code>using Microsoft.AspNetCore.Http;

public IActionResult Index()
{
	HttpContext.Session.SetString(&quot;key&quot;, &quot;123456&quot;);
	return View();  
}
</code></pre></div><p>如果不是在Controller 裡，你可以注入IHttpContextAccessor</p> <div class="language- extra-class"><pre class="language-text"><code>public class SomeOtherClass
{
   IHttpContextAccessor _httpContextAccessor;
   ISession _session =&gt; _httpContextAccessor.HttpContext.Session;

   public SomeOtherClass(IHttpContextAccessor httpContextAccessor){
      _httpContextAccessor = httpContextAccessor;
	}

   public void Set() {
      _session.SetString(&quot;key&quot;, &quot;123456&quot;);
   }
}
</code></pre></div><h3 id="使用sql-server"><a href="#使用sql-server" aria-hidden="true" class="header-anchor">#</a> 使用SQL Server</h3> <blockquote><p>nuget Microsoft.Extensions.Caching.SqlServer</p></blockquote> <p>Startup.cs</p> <div class="language- extra-class"><pre class="language-text"><code>services.AddSqlServerCache(o =&gt;
{
    o.ConnectionString = &quot; Server=.;Database=ASPNET5SessionState;Trusted_Connection=True; &quot; ;
    o.SchemaName = &quot; dbo &quot; ;
    o.TableName = &quot; Sessions &quot; ;
});
</code></pre></div><h3 id="使用redis"><a href="#使用redis" aria-hidden="true" class="header-anchor">#</a> 使用Redis</h3> <blockquote><p>nuget Microsoft.Extensions.Caching.Redis</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>services.AddSingleton&lt;IDistributedCache, RedisCache&gt;();
</code></pre></div><h2 id="內建di"><a href="#內建di" aria-hidden="true" class="header-anchor">#</a> 內建DI</h2> <p>在ASP.NET Core中有內置的DI容器有三種選擇</p> <ul><li><p>Singleton
意味著只創建一個實例. 該實例在需要它的所有組件之間共享. 因此始終使用相同的實例.</p></li> <li><p>Scoped
作用域意味著每個作用域創建一次實例. 每個對應用程序的請求都創建一個作用域，因此，每個請求都會創建一次註冊為作用域的組件。</p></li> <li><p>Transient
每次請求時都會創建瞬態組件，並且永遠不會共享.</p></li></ul> <p>Startup.cs</p> <div class="language- extra-class"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services) {
	services.AddSingleton(typeof(SomeOtherClass 
));
</code></pre></div><p>以下是新增Transient 的寫法</p> <div class="language- extra-class"><pre class="language-text"><code>services.Add(new ServiceDescriptor(typeof(IDataService), typeof(DataService), ServiceLifetime.Transient));
}
</code></pre></div><p>可以簡化成下面</p> <div class="language- extra-class"><pre class="language-text"><code>services.AddTransient&lt;IDataService, DataService&gt;();
services.AddTransient&lt;DataService&gt;();
</code></pre></div><p>或者你也可以使用</p> <div class="language- extra-class"><pre class="language-text"><code>services.AddTransient&lt;IDataService, DataService&gt;((ctx) =&gt;
{
    IOtherService svc = ctx.GetService&lt;IOtherService&gt;();
    //IOtherService svc = ctx.GetRequiredService&lt;IOtherService&gt;();
    return new DataService(svc);
});
</code></pre></div><h3 id="injection"><a href="#injection" aria-hidden="true" class="header-anchor">#</a> Injection</h3> <p>最基本的寫法如下</p> <div class="language- extra-class"><pre class="language-text"><code>public class LoggingMiddleware
{
    private readonly RequestDelegate _next;

    public LoggingMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task Invoke(HttpContext ctx)
    {
        Debug.WriteLine(&quot;Request starting&quot;);
        await _next(ctx);
        Debug.WriteLine(&quot;Request complete&quot;);
    }
}
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>public class LoggingMiddleware
{
    readonly RequestDelegate _next;
    readonly IDataService _svc;

    public LoggingMiddleware(RequestDelegate next, IDataService svc)
    {
        _next = next;
        _svc = svc;
    }

    public async Task Invoke(HttpContext ctx, IDataService svc2)
    {
        &lt;b&gt;IDataService svc3 = ctx.RequestServices.GetService&lt;IDataService&gt;();
		  &lt;/b&gt;
        Debug.WriteLine(&quot;Request starting&quot;);
        await _next(ctx);
        Debug.WriteLine(&quot;Request complete&quot;);
    }
}
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>public void Configure(IApplicationBuilder app) {

	IDataService dataSvc2 = app.ApplicationServices.GetService&lt;IDataService&gt;();

	app.Use((ctx, next) =&gt;
	{
		IDataService svc = ctx.RequestServices.GetService&lt;IDataService&gt;();
		return next();
	});

	app.Map(&quot;/test&quot;, subApp =&gt;
	{
		IDataService svc1 = subApp.ApplicationServices.GetService&lt;IDataService&gt;();
		subApp.Run((context =&gt;
		{
			IDataService svc2 = context.RequestServices.GetService&lt;IDataService&gt;();
			return context.Response.WriteAsync(&quot;Hello!&quot;);
		}));
	});

	app.MapWhen(ctx =&gt; ctx.Request.Path.StartsWithSegments(&quot;/test2&quot;), subApp =&gt;
	{
		IDataService svc1 = subApp.ApplicationServices.GetService&lt;IDataService&gt;();
		subApp.Run(ctx =&gt;
		{
			IDataService svc2 = ctx.RequestServices.GetService&lt;IDataService&gt;();
			return ctx.Response.WriteAsync(&quot;Hello!&quot;);
		});
	});
}
</code></pre></div><h2 id="injection-in-mvc-core"><a href="#injection-in-mvc-core" aria-hidden="true" class="header-anchor">#</a> Injection in MVC Core</h2> <div class="language- extra-class"><pre class="language-text"><code>public class HomeController : Controller
{
    private readonly IDataService _dataService;

    public HomeController(IDataService dataService)
    {
        _dataService = dataService;
    }

    [HttpGet]
    public IActionResult Index([FromServices] IDataService dataService2)
    {
        IDataService dataService3 = HttpContext.RequestServices.GetService&lt;IDataService&gt;();
        return View();
    }
}
</code></pre></div><h2 id="razor-views"><a href="#razor-views" aria-hidden="true" class="header-anchor">#</a> Razor views</h2> <div class="language- extra-class"><pre class="language-text"><code>@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
</code></pre></div><h2 id="tag-helpers"><a href="#tag-helpers" aria-hidden="true" class="header-anchor">#</a> Tag helpers</h2> <div class="language- extra-class"><pre class="language-text"><code>[HtmlTargetElement(&quot;test&quot;)]
public class TestTagHelper : TagHelper
{
    private readonly IDataService _dataService;

    public TestTagHelper(IDataService dataService)
    {
        _dataService = dataService;
    }
}
</code></pre></div><h2 id="view-components"><a href="#view-components" aria-hidden="true" class="header-anchor">#</a> View Components</h2> <div class="language- extra-class"><pre class="language-text"><code>public class TestViewComponent : ViewComponent
{
    private readonly IDataService _dataService;

    public TestViewComponent(IDataService dataService)
    {
        _dataService = dataService;
    }

    public async Task&lt;IViewComponentResult&gt; InvokeAsync()
    {
        return View();
    }
}
</code></pre></div><h2 id="filters"><a href="#filters" aria-hidden="true" class="header-anchor">#</a> Filters</h2> <p>MVC filters also support constructor injection, as well as having access to RequestServices:</p> <div class="language- extra-class"><pre class="language-text"><code>public class TestActionFilter : ActionFilterAttribute
{
    private readonly IDataService _dataService;

    public TestActionFilter(IDataService dataService)
    {
        _dataService = dataService;
    }

    public override void OnActionExecuting(ActionExecutingContext context)
    {
        Debug.WriteLine(&quot;OnActionExecuting&quot;);
    }

    public override void OnActionExecuted(ActionExecutedContext context)
    {
        Debug.WriteLine(&quot;OnActionExecuted&quot;);
    }
}
</code></pre></div><p>However, we can't add the attribute as usual on a controller since it has to get dependencies at runtime.</p> <p>We have these two options for adding it on controller- or action level:</p> <div class="language- extra-class"><pre class="language-text"><code>[TypeFilter(typeof(TestActionFilter))]
public class HomeController : Controller
{
}
// or
[ServiceFilter(typeof(TestActionFilter))]
public class HomeController : Controller
{
}
</code></pre></div><p>The key difference is that TypeFilterAttribute will figure out what are the filters dependencies, fetches them through DI, and creates the filter. ServiceFilterAttribute on the other hand attempts to find the filter from the service collection!</p> <p>To make [ServiceFilter(typeof(TestActionFilter))] work, we need a bit more configuration:</p> <div class="language- extra-class"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    services.AddTransient&lt;TestActionFilter&gt;();
}
</code></pre></div><p>Now ServiceFilterAttribute can find the filter.</p> <p>If you wanted to add the filter globally:</p> <div class="language- extra-class"><pre class="language-text"><code>public void ConfigureServices(IServiceCollection services)
{
    services.AddMvc(mvc =&gt;
    {
        mvc.Filters.Add(typeof(TestActionFilter));
    });
}
</code></pre></div><p>There is no need to add the filter to the service collection this time, it works as if you had added a TypeFilterAttribute on every controller.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/flashlin.github.io/DotNet-Core/20191112-1200-QuartzWithDi.html" class="prev">Quartz with Dotnet core DI</a></span> <span class="next"><a href="/flashlin.github.io/DotNet/20191026-1900-Redis-Master-Slave.html">ASP.NET Session &amp; Redis 高可用性設定</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/flashlin.github.io/assets/js/app.b3c6e42b.js" defer></script><script src="/flashlin.github.io/assets/js/2.d3d2ff54.js" defer></script><script src="/flashlin.github.io/assets/js/22.115aba78.js" defer></script>
  </body>
</html>
