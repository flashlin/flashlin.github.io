(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{408:function(e,s,a){"use strict";a.r(s);var t=a(4),n=Object(t.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"asp-net-session-redis-高可用性設定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#asp-net-session-redis-高可用性設定","aria-hidden":"true"}},[e._v("#")]),e._v(" ASP.NET Session & Redis 高可用性設定")]),e._v(" "),a("p",[e._v("2019-10-26")]),e._v(" "),a("h2",{attrs:{id:"準備-redis-設定檔案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#準備-redis-設定檔案","aria-hidden":"true"}},[e._v("#")]),e._v(" 準備 redis 設定檔案")]),e._v(" "),a("p",[e._v("首先進行 Redis Master Slave 設定,\n準備master 設定檔案: redis-6379.conf")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('port 6379 \nbind 192.168.11.202 \nrequirepass "myredis"\ndaemonize yes\nlogfile "6379.log" \ndbfilename "dump-6379.rdb" \ndir "/opt/soft/redis/data"\n\n#如若master設置了認證密碼，那麼所有redis數據節點都配置上masterauth屬性\nmasterauth "myredis"\n')])])]),a("p",[e._v("準備 Slave 設定檔案: redis-6380.conf")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('port 6380 \nbind 192.168.11.202 \nrequirepass "myredis"\ndaemonize yes\nlogfile "6380.log" \ndbfilename "dump-6380.rdb" \ndir "/opt/soft/redis/data"\n\n#如若master設置了認證密碼，那麼所有redis數據節點都配置上masterauth屬性\nmasterauth "myredis" \nslaveof 192.168.11.202 6379\n')])])]),a("h2",{attrs:{id:"啟動節點"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#啟動節點","aria-hidden":"true"}},[e._v("#")]),e._v(" 啟動節點")]),e._v(" "),a("p",[e._v("啟動 redis master & slave")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ redis-server redis-6379.conf\n$ redis-server redis-6380.conf\n")])])]),a("p",[e._v("確認主從關係")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ redis-cli -h 192.168.11.202 -p 6379 - a myredis info replication\n")])])]),a("p",[e._v('一旦主節點出現故障, 需要手動將一個 "從節點" 晉升為 "主節點", 同時需要修改應用方的主節點地址, 還需要命令其他從節點去複制新的主節點，整個過程需要人工干預')]),e._v(" "),a("h2",{attrs:{id:"準備-redis-sentinel-設定檔"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#準備-redis-sentinel-設定檔","aria-hidden":"true"}},[e._v("#")]),e._v(" 準備 Redis-Sentinel 設定檔")]),e._v(" "),a("p",[e._v("準備 redis-sentinel.conf 最基本的設定值如下, 請至少準備三台 sentinel")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("port 26379\ndaemonize yes\ndir /tmp\n\n# master1\n# 至少需要幾個 sentinel 同意，master_6379 才算失效，自動 failover。\nsentinel monitor master_6379 127.0.0.1 6379 1\n\n# 多少毫秒數內沒有回應，master_6379 就算失效。\nsentinel down-after-milliseconds master_6379 1000\n\n# 當 failover 發生時，最多可以有多少個 slave 從新的 master 同步資料。\nsentinel parallel-syncs master_6379 1\n\n# 多少毫秒數內沒有 failover 成功，就算 failover 失敗。\nsentinel failover-timeout master_6379 180000\n\n# master2\n...\n")])])]),a("p",[e._v("啟動 Redis-Sentinel")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# Start sentinel\n$ /usr/local/bin/redis-sentinel /etc/redis/sentinel_6379.conf\n$ /usr/local/bin/redis-sentinel /etc/redis/sentinel_6379.conf\n$ /usr/local/bin/redis-sentinel /etc/redis/sentinel_6379.conf\n")])])]),a("p",[e._v("檢查 Redis-Sentinel 狀態")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ redis-cli -h 127.0.01 -p 26379 info sentinel\n")])])]),a("h2",{attrs:{id:"高可用測試"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高可用測試","aria-hidden":"true"}},[e._v("#")]),e._v(" 高可用測試")]),e._v(" "),a("p",[e._v("手動停掉 6379 master 節點")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("$ redis-cli -h 192.168.11.202 -p 6379 -a myredis\n192.168.11.202:6379> shutdown\n")])])]),a("h2",{attrs:{id:"asp-net-session-state"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#asp-net-session-state","aria-hidden":"true"}},[e._v("#")]),e._v(" ASP.NET Session State")]),e._v(" "),a("p",[e._v("ASP.NET Web Application 進行配置")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Install-Package Microsoft.Web.RedisSessionStateProvider\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('<sessionState mode="Custom" customProvider="MySessionStateStore">\n  <providers>\n    <add name="MySessionStateStore" type="Microsoft.Web.Redis.RedisSessionStateProvider"\n         host=""\n         accessKey=""\n         ssl="true" />\n  </providers>\n</sessionState>\n')])])])])}),[],!1,null,null,null);s.default=n.exports}}]);